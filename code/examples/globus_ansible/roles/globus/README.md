Example Ansible for Globus Endpoint Setup
=========
Based on original work by Crystal Chua, AARNet.

This role deploys and configures an instance of Globus Connect Server 5.4 as well as any associated components.

This role can also remove an instance of Globus Connect Server 5.4 if the 'globus-destroy' and 'never' tags are specified.
Note that this action is IRREVERSIBLE. The instance cannot be restored once it has been unregistered from globus.org.

Prerequisites
------------

### Globus Service User
You will need to create a Globus service user before you can configure this role. The service user is a proxy for the user which creates it.

Please follow the instructions at the [Globus Automated Endpoint Deployment Guide](https://docs.globus.org/globus-connect-server/v5.4/automated-deployment/#register_for_service_credentials).

Additional information is available at [Globus How To Use Application Credentials or Service Accounts to Automate Data Transfer](https://docs.globus.org/guides/recipes/automate-with-service-account/).

You wil then need to hard-code the values of `globus_svc_client_id` and `globus_svc_client_id` in 'globus/defaults/main.yml'

### SSH keys
You will also need to have a valid SSH public key installed in authorized_hosts on the target machine for the remote Ansible user, and the private key accessible on the Ansible host with this repository.

### Hashicorp Vault (Optional)
If you have set up Hashicorp Vault, you will need to set `use_vault` to true and ensure that your secret paths `globus_secret_path.deploy_svc` and `globus_secret_path.deploy_key`are set appropriately. Leave `use_vault` set to false to use hard-coded values in `globus/defaults/main.yml` 

Role Variables
--------------
Note that some of the values are only relevant if yoy wish to (and have the permissions to) add the endpoint to an instituional subscription.

There are also values which have been commented out for the sake of simplicity, but are left in the scripts as a guide should you wish to re-enable the functionality. This applies specifically to the use of Hashicorp Vault.

### globus/defaults/main.yml
Note that there is a `globus/defaults/main.yml.template` file which should be copied to `globus/defaults/main.yml` and edited to suit your requirements
| variable                         | description |
| -------------------------------- | ----------- |
| `use_vault`                      | Defaults to false. Set to true if Hashcorp Vault is set up
| `globus_gcs_binary`              | path to globus-connect-server binary |
| `globus_collections_dir`         | base path under which all collections should be created |
| `globus_config_dir`              | path at which additional config applied via Ansible is stored |
| `globus_deploy_key_path`         | path at which the `deployment-key.json` file generated by endpoint setup is stored (will be stored in vault and removed from filesystem if `use_vault` is true) |
| `globus_node_setup_path`         | path at which the `node-info.json` file (generated by node setup) is stored |
| `globus_svc_client_id`           | client ID of the Globus auto-deploy service user (hard-coded but will be pulled from Vault if `use_vault` is true) |
| `globus_svc_secret_id`           | secret ID of the Globus auto-deploy service user (hard-coded but will be pulled from Vault if `use_vault` is true) |
| `globus_endpoint_id`             | ID of the Globus endpoint - set to empty string (will be pulled from Vault if it exists if `use_vault` is true) |
| `globus.metadata`                | dictionary that contains metadata passed to Globus when components are being created |
| `globus_metadata.organization`   | publicly viewable name of the organization that owns the Globus component (endpoint, collection etc) |
| `globus_metadata.department`     | publicly viewable name of the department within the organization that owns the Globus component (endpoint, collection etc) |
| `globus_metadata.contact_email`  | publicly viewable email address of the support contact for the Globus component (endpoint, collection etc) |
| `globus_metadata.info_link`      | publicly viewable link to a website with more information about the Globus endpoint |
| `globus_metadata.keywords`       | list of keywords to associate with the Globus component (endpoint, collection etc) |
| `globus_endpoint_network_use`    | explicitly set endpoint network use to 'normal' by default |
| `globus_default_storage_gateway` | dictionary defining a default storage gateway and collection to be created for each endpoint |
| `globus_local_user_mapping`      | list of email addresses to map to the local unix user 'globus' to enable specific users to read/write to the storage backend |
|                                  |
| __SUBSCRIPTION ONLY VALUES__     |
| `globus_subscription_id`         | UUID of the AARNet Globus subscription to be associated with the endpoint, or empty string for no subscription |
| `globus_endpoint_roles`          | list of dictionaries defining Globus entities and the level of access they should be allowed to the endpoint |
| `globus_endpoint_roles[].uuid`   | a valid Globus user or group UUID |
| `globus_endpoint_roles[].type`   | `type` is `identity` for a Globus user and `group` for a Globus group |
| `globus_endpoint_roles[].role`   | `role` is either `administrator` (full access), `activity_manager` (view endpoint config), `activity_monitor` (view tasks and endpoint activity) |
|                                  |
| __Used only if `use_vault` is true__ |
| `globus_secret_path.deploy_svc`  | vault path where Globus auto-deploy service user credentials are located |
| `globus_secret_path.deploy_key`  | vault path where the Globus endpoint's `deployment-key.json` secret is stored |

### inventory/all.yml and inventory/host_vars/\<hostname\>.yml
Note that there is a file `inventory/all.yml.template` that you will need to copy to `inventory/all.yml` and edit as required.

You will also need to copy `inventory/host_vars/globus-test-host.yml.template` to `inventory/host_vars/<hostname>.yml` where `<hostname>` is in the `globus.hosts` section of `inventory/all.yml`.

| variable                         | description |
| -------------------------------- | ----------- |
| `globus_endpoint_name`           | Required - name of the Globus endpoint (this should be unique to each endpoint) |
| `globus_external_ip`             | Required - externally accessible IP address of the Globus endpoint |
| `globus_endpoint_description`    | Optional - description of the Globus endpoint |
| `globus_endpoint_network_use`    | Optional - valid values are `minimal`, `normal` (default) or `aggressive` - [details available here](https://docs.globus.org/globus-connect-server/v5.4/index.html#setting_endpoint_network_use_options) |
| `globus_endpoint_keywords`       | Optional - list of keywords to associate with the Globus endpoint (combined with `globus_metadata.keywords`) |
| `globus_storage_gateways`        | Optional - list of dictionaries that define additional storage gateways to be created on the Globus endpoint - see below for details |

### storage gateway definition
The structure is the same for both the `globus_default_storage_gateway` and `globus_storage_gateways` variables.
```
- name: Name of storage gateway
  domain: aarnet.edu.au # Restricts storage gateway access to users with an identity in the specified domain(s)
  path_restrictions:
    none: # Globus will block access to listed paths
      - /
    read: # Globus will allow read access to listed paths
      - /srv/globus/collections/
    read_write: # Globus will allow read and write access to listed paths
      - /srv/globus/collections/example
  collections: # Collections associated with the gateway
    - name: "Example Collection"
      base_path: "/srv/globus/collections/example"
```

Dependencies
------------

N/A

Example Playbook
----------------

See `playbooks/globus.yml`

License
-------

BSD

Author Information
------------------

An optional section for the role authors to include contact information, or a website (HTML is not allowed).
